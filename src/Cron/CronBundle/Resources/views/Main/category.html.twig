{% extends '::base.html.twig' %}

	{% block navigation %}		
	<div id="nav">
		<div class="orderQuestions"><a href="{{ path('index') }}">{% trans %}Главная{% endtrans %}</a></div>
		<div class="categoryQuestions"><a style="color:#7A4216" href="{{ path('category') }}">по категориям</a></div>
		<div class="expressQuestions"><a href="{{ path('rush') }}">срочные</a></div>
	</div>
	{% endblock %}

	{% block content %}
        <script type="text/javascript">
            //Спам
			$(document).ready(function(){
				$('.spamButton').click(function(){
					$(this).addClass("spamButtonActive");
					var question_id = $(this).closest('.singleQuestion').attr('data-id');
					var that = $(this);
					$.ajax({'url': '{{ path("spamQuestion") }}', 'type':'post', 'data': 'question_id='+question_id,
						'fail': function(){
							that.removeClass("spamButtonActive");
						},
						'success': function() {
							that.closest('.singleQuestion').replaceWith($("<span class='spamMessage'>Этот вопрос помечен как спам!</span>"));
							$('.spamMessage').delay('5000').fadeOut('1000');
						}
					});
				});
				
				//Лайки
				$('.likeButton').click(function(){
					$(this).addClass("likeButtonActive");
					var question_id = $(this).closest('.singleQuestion').data('id');
					var answer_id = $(this).closest('.singleAnswer').data('id');
					var that = $(this);
					$.ajax({
                        'url': '{{ path("likeItem") }}',
                        'type':'post',
                        'data': {
                            question_id: question_id,
                            answer_id: answer_id
                        },
						'fail': function(){
							that.removeClass("likeButtonActive");
						}
					});
				});			
			});
        </script>
		<div style="max-height: 820px;overflow: auto;overflow-x: hidden;overflow-y: auto;width: 728px;">
		{% if curUser %}
        {% for category in categorized_questions %}
            <h2 class="categoryTitle">{{ category.getName() }}</h2>
            <div id="showQuestion">
                {% for item in category.questions %}
                    <div class="singleQuestion likable-item" data-id="{{ item.getId() }}">
                        <div class="userName">{{ item.user }}</div>
                        <div class="questionDate">{{ item.datetime|date('d.m.Y H:i') }}</div>
                        <div class="closeButton"></div>
                        <div style="clear: both;"></div>
                        <div class="questionText">
                        {{ item.text }}
                            <div class="socialIcons">
                                <div class="spamButton {% if curUser in item.spams %}spamButtonActive{% endif %}"></div>
                                <div class="likeButton {% if curUser in item.likes %}likeButtonActive{% endif %}"></div>
                                <div class="repostButton"></div>
                                <form class="answer">
                                    {% if item.iAnswered %}
                                        {% if item.getPrivate()<1 %}
                                            {% set answer_button_value = item.answers|length ~ ' отв.' %}
                                        {% else %}
                                            {% set answer_button_value = 'закрытый' %}
                                        {% endif %}
                                    {% else %}
                                        {% set answer_button_value = 'ответить' %}
                                    {% endif %}
                                    <input class="answerButton" type="button" value="{{ answer_button_value }}" />
                                </form>
                            </div>
                        </div>
                    </div>
                    {% if category.getId()==null or item.iAnswered %}
                        <div class="myAnswer {% if item.answers==null %}no-border{% endif %}">
                            {% if item.getPrivate()<1 %}
                                {% for answer in item.answers %}
                                    <div class="singleAnswer likable-item" data-user="{{ answer.getUser().getId() }}" data-id="{{ answer.getId() }}">
                                        <div class="userName">{{ answer.getUser().getNick() }}</div>
                                        <div class="answerDate">{{ answer.getPubDate()|date("Y-m-d H:i:s") }}</div>
                                        <div style="clear: both;"></div>
                                        <div class="questionText">
                                            {{ answer.getText() }}
                                            <div class="socialIcons">
                                                <div class="spamButton" title="Пометить как спам"></div>
                                                <div class="likeButton" title="Мне нравится!"></div>
                                                <div class="arrowButton inviteUser" title="Отправить приглашение в чат"></div>
                                                <div class="letterButton sendMessage" title="Отправить сообщение"></div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <form class="answerForm"></form>
                    {% else %}
                        <div class="myAnswer no-border">
                        </div>
                        <form class="answerForm">
                            <textarea class="answerTextarea" ></textarea>
                            <div class="answerFormNavigation">
                                <input class="cancelButton" type="button" value="отменить" />							
                                <input class="submitAnswerButton" type="submit" value="отправить" />
                            </div>
                        </form>
                    {% endif %}
                {% endfor %}
            </div>
        {% endfor %}
		{% else %}
		<p style="margin: 15px;">Необходимо авторизироваться, чтобы видеть вопросы по категориям</p>
		{% endif %}
		</div>
	{% endblock %}